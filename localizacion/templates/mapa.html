<!DOCTYPE html>
<html>
<head>
  <title>Mapa con Google Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <style>
    #map { height: 500px; width: 100%; margin-bottom: 20px; }
  </style>
</head>
<body class="p-3">
  <h2 class="mb-3">Selecciona ubicación fija en el mapa</h2>

  <div id="map"></div>

  <form method="POST" action="{% url 'mapa' %}">
    {% csrf_token %}
    lng: <input type="text" id="lng" name="lng" value="{{ lng }}"><br>
    lat: <input type="text" id="lat" name="lat" value="{{ lat }}"><br>
    <button type="submit" class="btn btn-primary mt-2">Actualizar ubicación</button>
  </form>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcpuX1pktDQvVKJCah-8QbqI_ovRoVlmY&libraries=geometry"></script>
  <script>
    let map, fixedMarker, userMarker, directionsService, directionsRenderer;

    function initMap() {
      const fixedLat = parseFloat("{{ lat }}");
      const fixedLng = parseFloat("{{ lng }}");
      const fixedPos = { lat: fixedLat, lng: fixedLng };

      map = new google.maps.Map(document.getElementById("map"), {
        center: fixedPos,
        zoom: 14,
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

      // Marcador fijo (editable)
      fixedMarker = new google.maps.Marker({
        position: fixedPos,
        map: map,
        draggable: true,
        title: "Ubicación fija"
      });

      fixedMarker.addListener("dragend", (e) => {
        const lat = e.latLng.lat().toFixed(6);
        const lng = e.latLng.lng().toFixed(6);
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
        calcularRuta();
      });

      // Click en mapa para mover marcador fijo
      map.addListener("click", (e) => {
        const lat = e.latLng.lat().toFixed(6);
        const lng = e.latLng.lng().toFixed(6);
        fixedMarker.setPosition(e.latLng);
        document.getElementById("lat").value = lat;
        document.getElementById("lng").value = lng;
        calcularRuta();
      });

      // Obtener ubicación actual del usuario
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const userPos = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
            };

            if (userMarker) {
              userMarker.setPosition(userPos);
            } else {
              userMarker = new google.maps.Marker({
                position: userPos,
                map: map,
                icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" },
                title: "Tu ubicación actual",
              });
            }

            calcularRuta();
          },
          (err) => console.error("Error al obtener ubicación:", err),
          { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
      }
    }

    // Calcular y dibujar ruta
    function calcularRuta() {
      if (!userMarker || !fixedMarker) return;

      const start = userMarker.getPosition();
      const end = fixedMarker.getPosition();

      const request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);

          const distancia = result.routes[0].legs[0].distance.text;
          const info = new google.maps.InfoWindow({
            content: `Distancia: ${distancia}`,
            position: end
          });
          info.open(map);
        } else {
          console.error("Error al trazar ruta:", status);
        }
      });
    }

    window.onload = initMap;
  </script>
</body>
</html>
